<!DOCTYPE html> <html> <head>   <meta charset="utf-8" />   <title>SharpFleet – Current State</title>   <style>     body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; }     h1 { font-size: 22pt; }     h2 { font-size: 16pt; margin-top: 18pt; }     h3 { font-size: 13pt; margin-top: 12pt; }     p, li { line-height: 1.35; }     table { border-collapse: collapse; width: 100%; }     th, td { border: 1px solid #bbb; padding: 6px 8px; vertical-align: top; }     th { background: #eee; }     code { font-family: Consolas, "Courier New", monospace; font-size: 10pt; }     .muted { color: #555; }   </style> </head> <body>  <h1>SharpFleet – Current State</h1> <p class="muted">   Generated: 2026-01-26<br />   Repo: SharpLync (Laravel / PHP / Blade)<br />   Scope: Customer SharpFleet portal (<code>/app/sharpfleet</code>) + internal platform admin (<code>/admin/sharpfleet</code>) </p>  <h2>0. Updates (Jan 28, 2026)</h2>
<ul>
<li><strong>Marketing How It Works video:</strong> replaced the YouTube embed with a local MP4, added a phone-device frame, autoplay + loop + muted + playsinline, and tuned mobile styling to avoid cropping.</li>
<li><strong>Video optimization:</strong> generated an optimized MP4 (~1.04 MB) and swapped the page to use <code>startend.optimized.mp4</code> for testing.</li>
<li><strong>Local tooling only:</strong> ffmpeg added to <code>.gitignore</code> so it stays local and is not committed.</li>
<li><strong>Mobile PWA offline trips reliability:</strong> offline start/end now handled directly in the mobile sheets, queued trips now visible in History, and start-trip sheet closes automatically after offline start.</li>
<li><strong>Mobile support data:</strong> support submissions now include the mobile app version.</li>
<li><strong>Mobile version tracking:</strong> centralized mobile version in config; current version is <strong>v1.2.2 (Mobile)</strong> with release timestamp <strong>28/01/2026 @ 8:25PM</strong>.</li>
<li><strong>PWA freshness:</strong> cache-busted mobile CSS and bumped the generic service worker cache version to ensure updates are pulled.</li>
</ul><h2>0. Updates (Jan 26, 2026)</h2> <ul> <li><strong>Company/Branch navigation refresh:</strong> Company dropdown reordered; branch admins now see "Branch" with branch-scoped Users access in the top nav.</li> <li><strong>User Admin page:</strong> added <code>/app/sharpfleet/admin/user-rights</code> for company admins to manage user groups, driver access, and branch access in one place (with role summary).</li> <li><strong>Role enforcement tightened:</strong> branch admins cannot view/manage company admin accounts; user lists and actions enforce this server-side.</li> <li><strong>Branch scoping defaults:</strong> branch-restricted users now default to their primary branch on reports (vehicle usage, utilization, fleet manager operational) and cannot access other branches.</li> <li><strong>Booking page branch filtering:</strong> booking driver and customer pickers are scoped to the user's branch access (with <code>user_branch_access</code> or <code>users.branch_id</code> fallback).</li> </ul> <h2>0. Updates (Jan 24, 2026)</h2> <ul> <li><strong>Reports hub + new Utilization report:</strong> added a new Utilization report under Reports Home with period presets (day/week/month), availability rules (business hours, 24/7, custom), summary cards, utilization % bars, status/recommendations, and CSV export.</li> <li><strong>Operational report improvements:</strong> Vehicle Usage report now has working filters (branch + date picker), auto-refresh on select, styled dropdowns, date picker icons, and CSV export.</li> <li><strong>AI Report Builder enhancements:</strong> intent parsing expanded to drivers/customers/vehicles/trips/branches/faults/bookings; CSV exports fixed; date/time now rendered in local timezone; AI card added to Reports Home with SharpFleet styling.</li> <li><strong>Mobile PWA support diagnostics:</strong> support emails/logs now capture page URL, current host, device_id, token existence, and auth path for faster debugging.</li> <li><strong>Mobile token auth admin tools:</strong> added &quot;Revoke all mobile sessions&quot; button for drivers; token revokes now audit-logged; token rotation on re-login enabled.</li> <li><strong>SharpFleet email branding:</strong> all SharpFleet emails now send as &quot;SharpFleet&quot; (not &quot;SharpLync Support&quot;).</li> <li><strong>Terms &amp; Conditions inside SharpFleet:</strong> added a SharpFleet-native Terms page at <code>/app/sharpfleet/terms</code>, updated register/subscribe links, and added Terms to the Help dropdown and public mobile menu.</li></ul> <h2>0. Updates (Jan 22, 2026)</h2> <ul>   <li><strong>Fuel receipts (mobile + admin):</strong> added a Fuel tab in Company Settings with a toggle and a destination email. Drivers can capture fuel receipts in-app (camera + review/retake) and submit from the PWA dashboard; receipts are saved to <code>sf_fuel_entries</code>, emailed to the configured address, and visible on vehicle details as the latest 5 receipts with delete actions.</li>   <li><strong>Support page for logged-in SharpFleet users:</strong> added a desktop support page under <code>/app/sharpfleet/support</code> (Help -> Support). Uses the same validation and logging fields as the mobile support flow, but sends a styled SharpFleet email template for web submissions.</li>   <li><strong>Admin vehicle details improvements:</strong> added a fuel receipts section on <code>/app/sharpfleet/admin/vehicles/{id}/details</code> with thumbnails and delete controls; images open in a new tab for quick review.</li>   <li><strong>PWA dashboard enhancements:</strong> added an "Add Fuel" card (when enabled) and made the "No Active Trip" card tappable to open the Start Trip sheet.</li>   <li><strong>Company Settings tabs:</strong> reorganized admin settings into tabbed sections for faster navigation (Client, Trip Rules, Vehicle Tracking, Reminders, Client Addresses, Safety, Incident Reporting, Fuel).</li> </ul>  <h2>0. Updates (Dec 31, 2025)</h2> <ul>   <li><strong>Admin top navigation regrouping:</strong> reorganized the SharpFleet admin top navigation into grouped dropdowns (Fleet / Operations / Reports / Company) to prevent overflow. The Company “Actions” links previously shown on <code>/app/sharpfleet/admin/company</code> were moved into the top nav Company dropdown. <em>Driver view remains unchanged</em> (drivers continue to only see Dashboard/Bookings/Help via the hamburger menu).</li>   <li><strong>Dropdown UX + branding reliability:</strong> improved hover reliability for dropdown menus (no “gap” when moving from top item to dropdown items), prevented wrapping for key nav labels, and added cache-busting for the logo asset to avoid stale-cached logos after deploys.</li>   <li><strong>Vehicles “Out of Service” (schema-optional):</strong> added support to mark vehicles out of service with a reason and note. When the DB supports it, the feature uses <code>vehicles.is_in_service</code> plus <code>vehicles.out_of_service_reason</code>, <code>vehicles.out_of_service_note</code>, <code>vehicles.out_of_service_at</code>. Out-of-service vehicles cannot be booked and cannot be used to start trips; server-side enforcement is applied and vehicle selection lists are filtered accordingly.</li>   <li><strong>Admin dashboard improvements:</strong> added a “Vehicles Out of Service” statistic (when schema supports it) and refactored vehicle reminders into a clearer card-based block.</li>   <li><strong>Help center refactor:</strong> refactored SharpFleet help pages into a modern “Setup Guide + Reference” model for admins and “Getting Started + Reference” for drivers, using lightweight collapsible sections (<code>&lt;details&gt;</code>/<code>&lt;summary&gt;</code>) and scoped help styling only (no routing/business logic changes).</li>   <li><strong>Public home page adjustments:</strong> moved the running vehicle banner higher in the hero, updated pricing copy (“per vehicle, per month”), updated the hero reassurance lines to “Covered.”, and tuned mobile banner performance (faster animation + improved label spacing/wrapping on small screens).</li> </ul>  <h2>0. Updates (Dec 30, 2025)</h2> <ul>   <li><strong>Incident / fault reporting (opt-in):</strong> implemented driver incident submission (during-trip and standalone) and an admin faults review page with status updates. Feature remains gated behind company settings (<code>faults.enabled</code>) and requires the tenant <code>faults</code> table to be created manually via the provided SQL script.</li>   <li><strong>Fault categories + archive support:</strong> faults now support subscriber-friendly categorisation (<code>report_type</code>: “Vehicle Issue” / “Vehicle Accident”) and an archive workflow (admin can archive items; archived items remain visible for audit/reporting).</li>   <li><strong>Pre-drive safety checklist (settings-driven):</strong> added a company-controlled pre-drive safety checklist that drivers must complete before starting a trip when enabled. Admins can configure checklist items; enforcement is server-side.</li>   <li><strong>SharpFleet password reset flow:</strong> implemented “forgot password” + reset email workflow for SharpFleet (mirrors SharpLync behaviour but uses SharpFleet-branded emails/templates). Requires manual tenant DB setup via the provided SQL script (no migrations).</li>   <li><strong>Logout reliability (PWA-aware):</strong> logout now clears the correct SharpFleet session key (<code>sharpfleet.user</code>), redirects to the SharpFleet public home, and the SharpFleet service worker treats logout/auth pages as network-only to avoid cached “logout does nothing” behaviour.</li>   <li><strong>Trip manual time capture (subscriber-toggle):</strong> added an admin setting to require drivers to enter explicit trip start/end date-times (when enabled) with server-side validation/enforcement and offline capture alignment.</li>   <li><strong>Driver start-trip form UX:</strong> reordered fields per the agreed workflow and made the “Customer/Client” label configurable via company settings (no hardcoded wording).</li>   <li><strong>Reporting redesign (settings-driven):</strong> trips reporting is now driven by subscriber/company reporting settings (not UI assumptions), with all decisions centralized in <code>App\Services\SharpFleet\ReportingService</code>. The Trips report UI displays “Applied settings” and disables/hides filters when overrides are not allowed; CSV export uses the same settings-driven dataset.</li>   <li><strong>Driver UI simplification:</strong> “Report an Incident” sections are now hidden by default and expand when the driver taps the header (“Tap to open”).</li>   <li><strong>Subscriber timezone display:</strong> key SharpFleet date/time displays (trips, bookings, faults) now render in the company’s configured timezone from settings.</li>   <li><strong>Settings enforcement (trip start):</strong> trip start now enforces company settings server-side for odometer rules and client presence. If odometer override is disabled, drivers cannot submit a different start reading than the last recorded reading; if odometer is not required, an empty start reading will auto-fill from the last known reading (and will still block if no baseline exists). If client presence is enabled and marked “required”, a business trip cannot start without a Yes/No selection. Disabled capture fields are ignored server-side.</li>   <li><strong>Bookings timezone correctness (input + enforcement):</strong> booking windows entered by admins/drivers are now interpreted in the company’s configured timezone and then stored/compared in UTC for overlap checks, availability lookups, and booking-vs-trip enforcement.</li> </ul>  <h2>0. Updates (Dec 29, 2025)</h2> <ul>   <li><strong>PWA freshness improvements:</strong> added server-side <code>no-store</code> headers for SharpFleet HTML GET responses via <code>App\Http\Middleware\SharpFleetNoStore</code> (applied to the <code>routes/sharpfleet.php</code> group) and improved the service worker update flow to auto-refresh when a new worker takes control (online only).</li>   <li><strong>Driver dashboard live “Last KM” refresh:</strong> added <code>GET /app/sharpfleet/trips/last-reading</code> (driver-authenticated) returning the latest ended-trip reading for a selected vehicle; the dashboard now refreshes this value on vehicle change and when the PWA/tab returns to the foreground.</li>   <li><strong>Admin dashboard cleanup:</strong> removed the “Quick Actions” block and duplicate logout button from the admin dashboard; moved the missing destinations (Customers, Company) into the top navigation (admin view) to keep the UI consistent.</li>   <li><strong>SharpFleet UI text color:</strong> standardized page headers (title/description) to render white on the gradient background and added a <code>text-white</code> utility for the few marketing sections that should always be white; updated SharpFleet landing/test pages accordingly.</li> </ul>  <h2>1. Executive Summary</h2> <ul>   <li>SharpFleet is implemented as a Laravel module with its own session namespace (<code>sharpfleet.user</code>) and role model (<code>admin</code> vs <code>driver</code> plus <code>is_driver</code> flag).</li>   <li>Core functionality is implemented for trips (start/end + offline sync), vehicles CRUD, bookings (optional table), customers (optional table), company settings, users/invites, and trip reports (CSV export).</li>   <li>Fault / incident reporting is implemented as an opt-in company setting and requires manual tenant DB setup (no migrations).</li>   <li>A PWA-style offline experience exists for the driver dashboard (service worker + offline trip capture), with a “best effort” sync endpoint.</li><li>Mobile PWA uses device-bound token auth (sharpfleet_mobile_tokens) with CSRF bypass for valid token requests; Start/End/Offline-sync never return 419.</li>   <li>Trial gating is enforced via middleware (<code>SharpFleetTrialCheck</code>) and now delegates all allow/deny decisions to a central service (<code>App\Services\SharpFleet\EntitlementService</code>).</li> </ul>  <h2>2. Architecture & Key Concepts</h2>  <h3>2.1 Routing</h3> <ul>   <li>Customer portal routes: <code>routes/sharpfleet.php</code></li>   <li>Internal platform admin routes: <code>routes/admin.php</code> (under <code>/admin/sharpfleet</code>)</li> </ul> <p class="muted">Domain routing (from <code>routes/web.php</code>):</p> <ul>   <li><code>sharpfleet.com.au</code> â†’ redirects to <code>/sharpfleet</code></li>   <li><code>sharpfleet.au</code> â†’ redirects to <code>/sharpfleet</code></li>   <li><code>sharpfleet.co.nz</code> â†’ redirects to <code>/sharpfleet</code></li>   <li><code>sharpfleet.co.za</code> â†’ redirects to <code>/sharpfleet</code></li>   <li><code>sharpfleet.app</code> â†’ redirects to <code>/app/sharpfleet/mobile</code></li>   <li><code>fleet.sharplync.com.au</code> â†’ redirects to <code>/sharpfleet</code></li> </ul>  <h3>2.2 Authentication & Session Model</h3> <ul>   <li>SharpFleet login state is stored in <code>session('sharpfleet.user')</code> (id, organisation_id, email, role, is_driver, logged_in, etc.).</li>   <li>Remember-me is implemented with a cookie (<code>sharpfleet_remember</code>) and a server-side token stored in <code>users.remember_token</code> (hashed/checked with sha256).</li>   <li>SSO exists at <code>/app/sharpfleet/sso</code>, using HMAC SHA-256 signed query parameters, timestamp window checks, and nonce replay protection (nonce stored in session).</li> </ul><h3>2.2.1 Mobile PWA Token Auth</h3><ul><li>Mobile routes are protected by <code>App\\Http\\Middleware\\MobileDriverTokenAuth</code> (token auth first, session fallback second).</li><li>Tokens are stored in <code>sharpfleet_mobile_tokens</code> (hashed token, device_id, user_id, organisation_id, last_used_at, revoked_at).</li><li>Tokens are issued on mobile login when <code>mobile_login=1</code> and <code>device_id</code> is present (driver-only), via <code>App\\Services\\SharpFleet\\MobileTokenService</code>.</li><li>The PWA stores <code>sf_device_id</code> + <code>sf_device_token</code> in localStorage and sends <code>Authorization: Bearer</code> (or <code>X-Device-Token</code>) with <code>X-Device-Id</code>.</li><li>CSRF is bypassed for valid mobile token requests; Start/End/Offline-sync never return 419 (202 on missing/invalid token).</li><li>Token rotation happens on re-login for the same device_id; admin can revoke all mobile sessions for a driver.</li></ul><h3>2.3 Authorization</h3> <ul>   <li>Admin access middleware: <code>App\Http\Middleware\SharpFleetAdminAuth</code>.</li>   <li>Driver access middleware: <code>App\Http\Middleware\SharpFleetDriverAuth</code> (allows role driver, or admin with <code>is_driver</code>).</li>   <li>Trial gating middleware: <code>App\Http\Middleware\SharpFleetTrialCheck</code> (delegates decisions to <code>App\Services\SharpFleet\EntitlementService</code>).</li> </ul>  <h3>2.4 Data Access & Schema Dependencies</h3> <ul>   <li>SharpFleet uses <code>DB::connection('sharpfleet')</code> heavily, including directly in Blade templates for some pages.</li>   <li>Feature availability sometimes depends on tables/columns existing. Notably:     <ul>       <li><code>customers</code> table: enables customer capture/listing/import.</li>       <li><code>bookings</code> table: enables bookings and booking overlap enforcement.</li>       <li><code>vehicles.starting_km</code>, <code>vehicles.registration_expiry</code>, <code>vehicles.service_due_date</code>, <code>vehicles.service_due_km</code> columns: enable additional vehicle tracking fields.</li>       <li><code>vehicles.is_in_service</code>, <code>vehicles.out_of_service_reason</code>, <code>vehicles.out_of_service_note</code>, <code>vehicles.out_of_service_at</code> columns: enable “Out of Service” status + enforcement (booking/trip blocking) and related UI.</li>     </ul>   </li> </ul>  <h3>2.5 Company Settings / Feature Flags</h3> <p>   Company settings are stored in <code>company_settings.settings_json</code> and accessed via   <code>App\Services\SharpFleet\CompanySettingsService</code>. Key toggles include: </p> <ul>   <li>Trip rules: odometer required, allow private trips, etc.</li>   <li>Client presence: enabled/required, label, address capture enabled.</li>   <li>Customer capture: enabled, allow select/manual.</li>   <li>Safety checks: enabled, required, checklist items.</li>   <li>Vehicle tracking: registration tracking, servicing tracking.</li>   <li>Fuel receipts: enable uploads and configure the destination email address.</li> </ul>  <h3>2.6 PWA / Offline Driver Trips</h3> <ul>   <li>Service worker: <code>public/app/sharpfleet-sw.js</code> (scoped to <code>/app/sharpfleet/</code>).</li>   <li>Manifest: <code>public/app/sharpfleet.webmanifest</code> (start_url points at <code>/app/sharpfleet/driver</code>).</li>   <li>Offline fallback: <code>public/app/sharpfleet-offline.html</code>.</li>   <li>Driver dashboard supports offline trip capture using <code>localStorage</code> and syncs to <code>POST /app/sharpfleet/trips/offline-sync</code> when online.</li>   <li>Driver dashboard now includes an optional Fuel receipt capture flow (camera + review) when enabled in settings.</li>   <li>To avoid stale authenticated pages in PWA/app shells, SharpFleet sets explicit <code>Cache-Control: no-store</code> headers for SharpFleet HTML GET responses via <code>App\Http\Middleware\SharpFleetNoStore</code>.</li> </ul><h3>2.7 AI Report Builder (Admin)</h3><ul><li>Route: <code>/app/sharpfleet/admin/reports/ai-report-builder</code> (GET/POST).</li><li>Controller: <code>App\\Http\\Controllers\\SharpFleet\\Reports\\AiReportBuilderController</code>.</li><li>Intent parsing via <code>App\\Services\\SharpFleet\\ReportAiClient::parseIntent</code> (no SQL generation).</li><li>Supported report types: trips, vehicles, customers, customers_with_trips, users, branches, faults, bookings.</li><li>Applies organisation + branch scope; optional filters for date range, client present, and vehicles with registration numbers.</li><li>CSV export uses the same dataset as the on-screen table; pagination defaults to 10 with a selector.</li></ul><h2>3. Page-by-Page Inventory (Customer SharpFleet Portal)</h2>  <h3>3.1 Public / Entry</h3> <table>   <tr>     <th>URL</th>     <th>View</th>     <th>Auth</th>     <th>Notes</th>   </tr>   <tr>     <td><code>GET /sharpfleet</code></td>     <td><code>resources/views/sharpfleet/home.blade.php</code></td>     <td>Public</td>     <td>Marketing/landing entrypoint to SharpFleet.</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet</code></td>     <td>Redirect/entry logic</td>     <td>Public</td>     <td>Redirects based on <code>session('sharpfleet.user')</code> role to admin/driver, else to login.</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/test-home</code></td>     <td><code>resources/views/sharpfleet/test-home.blade.php</code></td>     <td>Public</td>     <td>Additional test/marketing page.</td>   </tr> </table>  <h3>3.2 Login / Logout / SSO</h3> <table>   <tr>     <th>URL</th>     <th>Controller</th>     <th>View</th>     <th>Notes</th>   </tr>   <tr>     <td><code>GET /app/sharpfleet/login</code></td>     <td><code>App\Http\Controllers\SharpFleet\AuthController@showLogin</code></td>     <td><code>resources/views/sharpfleet/login.blade.php</code></td>     <td>Also checks remember-me cookie and auto-logs in if valid.</td>   </tr>   <tr>     <td><code>POST /app/sharpfleet/login</code></td>     <td><code>AuthController@login</code></td>     <td>—</td>     <td>Validates credentials against <code>users.password_hash</code>.</td>   </tr>   <tr>     <td><code>POST /app/sharpfleet/logout</code></td>     <td><code>AuthController@logout</code></td>     <td>—</td>     <td>Clears SharpFleet session + remember cookie.</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/sso</code></td>     <td><code>App\Http\Controllers\SharpFleet\SsoController@login</code></td>     <td>—</td>     <td>HMAC-signed SSO. Restricts return URL to <code>/app/sharpfleet/admin...</code>. Logs in existing admins only.</td>   </tr> </table>  <p class="muted">   Note: A template exists at <code>resources/views/sharpfleet/admin/login.blade.php</code>, but the primary customer login view used by the controller is <code>resources/views/sharpfleet/login.blade.php</code>. </p>  <h3>3.3 Registration / Activation (Admin user)</h3> <table>   <tr>     <th>URL</th>     <th>Controller</th>     <th>View</th>     <th>Notes</th>   </tr>   <tr>     <td><code>GET /app/sharpfleet/admin/register</code></td>     <td><code>App\Http\Controllers\SharpFleet\Admin\RegisterController@show</code></td>     <td><code>resources/views/sharpfleet/admin/register.blade.php</code></td>     <td>Registration form for a new SharpFleet organisation + admin.</td>   </tr>   <tr>     <td><code>POST /app/sharpfleet/admin/register</code></td>     <td><code>RegisterController@register</code></td>     <td>—</td>     <td>Sends activation email; logs to <code>sharpfleet-registration.log</code>.</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/register/success</code></td>     <td>—</td>     <td><code>resources/views/sharpfleet/admin/register-success.blade.php</code></td>     <td>Success message after registration request.</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/activate/{token}</code></td>     <td><code>RegisterController@showActivateForm</code></td>     <td><code>resources/views/sharpfleet/admin/activate-account.blade.php</code></td>     <td>Token must be valid + unexpired.</td>   </tr>   <tr>     <td><code>POST /app/sharpfleet/activate/complete</code></td>     <td><code>RegisterController@completeActivation</code></td>     <td>—</td>     <td>Creates organisation, activates user, sends emails, logs in.</td>   </tr> </table>  <h3>3.4 Driver Invite Acceptance (Public)</h3> <table>   <tr>     <th>URL</th>     <th>Controller</th>     <th>View</th>     <th>Notes</th>   </tr>   <tr>     <td><code>GET /app/sharpfleet/invite/{token}</code></td>     <td><code>App\Http\Controllers\SharpFleet\DriverInviteController@showAcceptForm</code></td>     <td><code>resources/views/sharpfleet/admin/activate-driver.blade.php</code></td>     <td>Validates pending driver with token + expiry; shows set-password form.</td>   </tr>   <tr>     <td><code>POST /app/sharpfleet/invite/complete</code></td>     <td><code>DriverInviteController@complete</code></td>     <td>—</td>     <td>Sets driver details + password, activates user, logs in as driver.</td>   </tr> </table>  <h3>3.5 Admin Portal Pages (<code>/app/sharpfleet/admin</code>)</h3> <p>   These routes require SharpFleet admin authentication and (generally) trial to be active.   Primary middleware: <code>SharpFleetAdminAuth</code> and <code>SharpFleetTrialCheck</code>. </p>  <table>   <tr>     <th>URL</th>     <th>View</th>     <th>Controller / Backing logic</th>     <th>Key behaviors</th>   </tr>   <tr>     <td><code>GET /app/sharpfleet/admin</code></td>     <td><code>resources/views/sharpfleet/admin/dashboard.blade.php</code></td>     <td>Inline route closure in <code>routes/sharpfleet.php</code></td>     <td>Counts drivers/vehicles/active trips; shows vehicle reminder digest as a card; includes an out-of-service vehicle count when schema supports it. Navigation actions are provided via the top nav (no duplicate “quick actions” panel).</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/admin/company</code></td>     <td><code>resources/views/sharpfleet/admin/company.blade.php</code></td>     <td><code>SharpFleet\Admin\CompanyController@index</code></td>     <td>Organisation overview + usage counts; surfaces settings state. Company “Actions” links are provided via the admin top nav (Company dropdown) to avoid duplicated UI.</td>   </tr>   <tr>     <td><code>GET/POST /app/sharpfleet/admin/company/profile</code></td>     <td><code>resources/views/sharpfleet/admin/company-profile.blade.php</code></td>     <td><code>CompanyProfileController@edit/@update</code></td>     <td>Edit org profile; timezone stored in company settings.</td>   </tr>   <tr>     <td><code>GET/POST /app/sharpfleet/admin/settings</code></td>     <td><code>resources/views/sharpfleet/admin/settings.blade.php</code></td>     <td><code>CompanySettingsController@index/@update</code></td>     <td>Tabbed settings UI with feature toggles (client presence, customers, private trips, rego/service tracking, fuel receipts, etc.).</td>   </tr>   <tr>     <td><code>GET/POST /app/sharpfleet/admin/safety-checks</code></td>     <td><code>resources/views/sharpfleet/admin/safety-checks.blade.php</code></td>     <td><code>CompanySafetyCheckController@index/@update</code></td>     <td>Defines checklist items stored in settings JSON.</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/admin/vehicles</code></td>     <td><code>resources/views/sharpfleet/admin/vehicles/index.blade.php</code></td>     <td><code>VehicleController@index</code></td>     <td>Vehicle list + active trip indicator; archive supported. When enabled by schema, shows in/out-of-service status.</td>   </tr>   <tr>     <td><code>GET/POST /app/sharpfleet/admin/vehicles/create</code></td>     <td><code>resources/views/sharpfleet/admin/vehicles/create.blade.php</code></td>     <td><code>VehicleController@create/@store</code></td>     <td>Fields depend on optional DB columns (registration/service/starting_km). When enabled by schema, includes “Out of Service” status fields (reason + note).</td>   </tr>   <tr>     <td><code>GET/POST /app/sharpfleet/admin/vehicles/{id}/edit</code></td>     <td><code>resources/views/sharpfleet/admin/vehicles/edit.blade.php</code></td>     <td><code>VehicleController@edit/@update</code></td>     <td>Rego is intentionally not updated in service layer. When enabled by schema, supports setting vehicle in/out of service (reason + note) and clears out-of-service fields when returned to service.</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/admin/vehicles/{id}/details</code></td>     <td><code>resources/views/sharpfleet/admin/vehicles/details.blade.php</code></td>     <td><code>VehicleController@details</code></td>     <td>Usage summary, servicing, faults, and latest fuel receipts (thumbnails + delete).</td>   </tr>   <tr>     <td><code>GET/POST /app/sharpfleet/admin/customers</code></td>     <td><code>resources/views/sharpfleet/admin/customers/index.blade.php</code></td>     <td><code>CustomerController@index/@store</code></td>     <td>Supports add and CSV import; blocked if customers table missing (with SQL guidance).</td>   </tr>   <tr>     <td><code>GET/POST /app/sharpfleet/admin/bookings</code></td>     <td><code>resources/views/sharpfleet/admin/bookings/index.blade.php</code></td>     <td><code>SharpFleet\Admin\BookingController</code></td>     <td>Creates bookings, changes vehicle, cancels booking; availability endpoint used by JS.</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/admin/users</code></td>     <td><code>resources/views/sharpfleet/admin/users/index.blade.php</code></td>     <td><code>UserController@index</code></td>     <td>Manage users; toggle driver access via <code>is_driver</code>.</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/admin/user-rights</code></td>     <td><code>resources/views/sharpfleet/admin/users/user-rights.blade.php</code></td>     <td><code>UserRightsController@index</code></td>     <td>Company admin user rights hub (role, driver access, branch access).</td>   </tr>   <tr>     <td><code>GET/POST /app/sharpfleet/admin/users/invite</code></td>     <td><code>resources/views/sharpfleet/admin/users/invite.blade.php</code></td>     <td><code>DriverInviteController@create/@store</code></td>     <td>Creates pending driver user + activation token + email.</td>   </tr>   <tr>     <td><code>GET/POST /app/sharpfleet/admin/users/{id}/edit</code></td>     <td><code>resources/views/sharpfleet/admin/users/edit.blade.php</code></td>     <td><code>UserController@edit/@update</code></td>     <td>Editing self updates SharpFleet session fields.</td>   </tr>   <tr><td><code>GET /app/sharpfleet/admin/reports</code></td><td><code>resources/views/sharpfleet/admin/reports/index.blade.php</code></td><td>Report home</td><td>Card-based report hub (Operational / Compliance / Planned).</td></tr><tr><td><code>GET/POST /app/sharpfleet/admin/reports/fleet-manager-operational</code></td><td><code>resources/views/sharpfleet/admin/reports/fleet-manager-operational.blade.php</code></td><td><code>FleetManagerOperationalReportController</code></td><td>Operational daily/weekly fleet usage report with CSV export.</td></tr><tr><td><code>GET/POST /app/sharpfleet/admin/reports/vehicle-usage</code></td><td><code>resources/views/sharpfleet/admin/reports/vehicle-usage.blade.php</code></td><td><code>VehicleUsageReportController</code></td><td>Vehicle usage report (filters + CSV export).</td></tr><tr><td><code>GET/POST /app/sharpfleet/admin/reports/ai-report-builder</code></td><td><code>resources/views/sharpfleet/admin/reports/ai-report-builder.blade.php</code></td><td><code>AiReportBuilderController</code></td><td>AI-assisted report builder with CSV export.</td></tr><tr><td><code>GET /app/sharpfleet/admin/reports/trips</code></td>     <td><code>resources/views/sharpfleet/admin/reports/trips.blade.php</code></td>     <td><code>ReportController@trips</code></td>     <td>Trip report with filters + totals; CSV export supported.</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/admin/reports/vehicles</code></td>     <td>—</td>     <td><code>ReportController@vehicles</code></td>     <td><strong>Not implemented</strong> (stub).</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/admin/trial-expired</code></td>     <td><code>resources/views/sharpfleet/admin/trial-expired.blade.php</code></td>     <td>Route closure</td>     <td>Explains restrictions; contains hard-coded upgrade plan cards (no backing integration).</td>   </tr> </table>  <h3>3.6 Driver Portal Pages (<code>/app/sharpfleet/driver</code>)</h3> <p>   These routes require driver auth and trial check.   Primary middleware: <code>SharpFleetDriverAuth</code> and <code>SharpFleetTrialCheck</code>. </p>  <table>   <tr>     <th>URL</th>     <th>View</th>     <th>Controller / Backing logic</th>     <th>Key behaviors</th>   </tr>   <tr>     <td><code>GET /app/sharpfleet/driver</code></td>     <td><code>resources/views/sharpfleet/driver/dashboard.blade.php</code></td>     <td>View performs multiple DB queries directly; submits to TripController endpoints</td>     <td>       Start/end trips, optional customer/client presence capture, vehicle search UI for large fleets,       offline trip capture + later sync. Includes a lightweight refresh to pull the latest “last reading” for the selected vehicle in PWA scenarios.     </td>   </tr>   <tr>     <td><code>POST /app/sharpfleet/trips/start</code></td>     <td>—</td>     <td><code>App\Http\Controllers\SharpFleet\TripController@start</code> ? <code>TripService@startTrip</code></td>     <td>       Enforces odometer rules + “booking lock” (blocks if another driver has active booking now).       Does <em>not</em> require that the driver has a booking; it only prevents conflicts.     </td>   </tr>   <tr>     <td><code>POST /app/sharpfleet/trips/end</code></td>     <td>—</td>     <td><code>TripController@end</code> ? <code>TripService@endTrip</code></td>     <td>Only ends driver’s own active trip.</td>   </tr>   <tr>     <td><code>POST /app/sharpfleet/trips/offline-sync</code></td>     <td>—</td>     <td><code>TripController@offlineSync</code> ? <code>TripService@syncOfflineTrips</code></td>     <td>Best-effort sync; de-dupes by started_at; re-checks booking lock at trip started time.</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/trips/last-reading</code></td>     <td>—</td>     <td><code>App\Http\Controllers\SharpFleet\TripController@lastReading</code></td>     <td>Returns latest ended-trip reading for a vehicle as JSON (used by the driver dashboard to stay fresh without a full reload).</td>   </tr>   <tr>     <td><code>GET /app/sharpfleet/bookings</code></td>     <td><code>resources/views/sharpfleet/driver/bookings/upcoming.blade.php</code></td>     <td><code>App\Http\Controllers\SharpFleet\BookingController@upcoming</code></td>     <td>Upcoming planned bookings; vehicle availability lookup endpoint used.</td>   </tr>   <tr>     <td><code>POST /app/sharpfleet/bookings</code></td>     <td>—</td>     <td><code>BookingController@store</code> ? <code>BookingService@createBooking</code></td>     <td>Creates driver booking (bookings table required). Bookings must start in the future.</td>   </tr>   <tr>     <td><code>POST /app/sharpfleet/bookings/{booking}/cancel</code></td>     <td>—</td>     <td><code>BookingController@cancel</code> ? <code>BookingService@cancelBooking</code></td>     <td>Driver can only cancel own bookings.</td>   </tr>   <tr>     <td><code>POST /app/sharpfleet/bookings/start-trip</code></td>     <td>—</td>     <td><code>BookingController@startTrip</code></td>     <td><strong>Not implemented</strong> (aborts 404).</td>   </tr> </table>  <h3>3.7 Debug / Errors</h3> <table>   <tr>     <th>URL / Page</th>     <th>View</th>     <th>Notes</th>   </tr>   <tr>     <td><code>GET /app/sharpfleet/debug</code></td>     <td><code>resources/views/sharpfleet/debug.blade.php</code></td>     <td>Admin-auth only debug information page.</td>   </tr>   <tr>     <td>Driver denied</td>     <td><code>resources/views/sharpfleet/errors/driver-denied.blade.php</code></td>     <td>Shown when user is not permitted as driver (<code>is_driver</code> not set).</td>   </tr> </table>  <h2>4. Internal Platform Admin (SharpLync Admin)</h2> <p>   Internal staff pages live under <code>/admin/sharpfleet</code> and are protected by the main admin auth middleware.   Routes: <code>routes/admin.php</code> using <code>App\Http\Controllers\Admin\SharpFleet\PlatformController</code>. </p>  <table>   <tr>     <th>URL</th>     <th>View</th>     <th>Purpose</th>   </tr>   <tr>     <td><code>GET /admin/sharpfleet</code></td>     <td><code>resources/views/admin/sharpfleet/index.blade.php</code></td>     <td>Organisation list/search; shows counts.</td>   </tr>   <tr>     <td><code>GET /admin/sharpfleet/organisations/{organisationId}</code></td>     <td><code>resources/views/admin/sharpfleet/organisations/show.blade.php</code></td>     <td>Organisation detail with conditional billing columns if present.</td>   </tr>   <tr>     <td><code>GET /admin/sharpfleet/organisations/{organisationId}/users</code></td>     <td><code>resources/views/admin/sharpfleet/organisations/users.blade.php</code></td>     <td>List organisation users.</td>   </tr>   <tr>     <td><code>GET /admin/sharpfleet/organisations/{organisationId}/vehicles</code></td>     <td><code>resources/views/admin/sharpfleet/organisations/vehicles.blade.php</code></td>     <td>List organisation vehicles.</td>   </tr>   <tr>     <td><code>GET /admin/sharpfleet/vehicles/{vehicleId}</code></td>     <td><code>resources/views/admin/sharpfleet/vehicles/show.blade.php</code></td>     <td>Vehicle detail with dynamic columns.</td>   </tr> </table>  <h2>5. Implemented vs Not Implemented</h2>  <h3>Implemented</h3> <ul>   <li>Trips: start/end + offline sync (<code>TripController</code> + <code>TripService</code>).</li>   <li>Vehicles: admin CRUD + archive (<code>SharpFleet\Admin\VehicleController</code> + <code>VehicleService</code>).</li>   <li>Bookings: create/cancel + overlap logic + availability (<code>BookingController</code> + <code>BookingService</code>), gated by <code>bookings</code> table existence.</li>   <li>Customers: add + CSV import (<code>CustomerController</code> + <code>CustomerService</code>), gated by <code>customers</code> table existence.</li>   <li>Driver invites: admin invite + public acceptance (<code>SharpFleet\Admin\DriverInviteController</code> and <code>SharpFleet\DriverInviteController</code>).</li>   <li>Reports: trips + fleet manager operational + vehicle usage + AI Report Builder (CSV export).</li>   <li>Faults / incidents: driver submission + admin review/status updates (<code>FaultController</code>, <code>SharpFleet\Admin\FaultController</code>, <code>FaultService</code>), gated by company setting + tenant table existence.</li> </ul>  <h3>Not Implemented / Stubbed</h3> <ul>   <li>Vehicle report: <code>SharpFleet\Admin\ReportController@vehicles</code> is stubbed.</li>   <li>Start trip from booking: route exists, but <code>App\Http\Controllers\SharpFleet\BookingController@startTrip</code> aborts 404.</li> </ul>  <h2>6. Known Inconsistencies / Risks (Current State)</h2> <ul>   <li><strong>Trial allow/deny rules are centralized:</strong> the allow/deny decision is now centralized in <code>EntitlementService</code> and consumed by <code>SharpFleetTrialCheck</code>; existing SharpFleet routes are still mostly unnamed so request matching remains URI-based (reports/logout).</li>   <li><strong>Trial expired page contains incorrect links:</strong> the CTA links to <code>/app/sharpfleet/admin/reports</code> and posts to <code>/app/sharpfleet/admin/logout</code>, which do not match the defined routes (<code>/app/sharpfleet/admin/reports/trips</code> and <code>/app/sharpfleet/logout</code>).</li>   <li><strong>Settings accessor typo:</strong> <code>CompanySettingsService::odometerAutofillEnabled()</code> reads a misspelled key (<code>odometer_autofillill_from_last_trip</code>), effectively making the accessor fall back to default behavior.</li>   <li><strong>Booking enforcement for trips is “conflict only”:</strong> <code>TripService</code> blocks starting a trip only if another driver has an overlapping active booking; it does not require that the current driver has a booking.</li>   <li><strong>Offline sync constraints:</strong> offline trips de-dupe on exact <code>started_at</code>; booking lock is re-evaluated at the offline trip’s start time (best-effort), and schema/table absence disables some enforcement.</li> </ul>  <h2>7. Appendix – View Inventory</h2> <p class="muted">Customer portal views (<code>resources/views/sharpfleet/**</code>):</p> <ul>   <li><code>sharpfleet/home.blade.php</code></li>   <li><code>sharpfleet/test-home.blade.php</code></li>   <li><code>sharpfleet/login.blade.php</code></li>   <li><code>sharpfleet/debug.blade.php</code></li>   <li><code>sharpfleet/errors/driver-denied.blade.php</code></li>   <li><code>sharpfleet/driver/dashboard.blade.php</code></li>   <li><code>sharpfleet/driver/bookings/upcoming.blade.php</code></li>   <li><code>sharpfleet/admin/dashboard.blade.php</code></li>   <li><code>sharpfleet/admin/settings.blade.php</code></li>   <li><code>sharpfleet/admin/safety-checks.blade.php</code></li>   <li><code>sharpfleet/admin/company.blade.php</code></li>   <li><code>sharpfleet/admin/company-profile.blade.php</code></li>   <li><code>sharpfleet/admin/vehicles/index.blade.php</code></li>   <li><code>sharpfleet/admin/vehicles/create.blade.php</code></li>   <li><code>sharpfleet/admin/vehicles/edit.blade.php</code></li>   <li><code>sharpfleet/admin/vehicles/details.blade.php</code></li>   <li><code>sharpfleet/admin/customers/index.blade.php</code></li>   <li><code>sharpfleet/admin/bookings/index.blade.php</code></li>   <li><code>sharpfleet/admin/reports/index.blade.php</code></li><li><code>sharpfleet/admin/reports/fleet-manager-operational.blade.php</code></li><li><code>sharpfleet/admin/reports/vehicle-usage.blade.php</code></li><li><code>sharpfleet/admin/reports/ai-report-builder.blade.php</code></li><li><code>sharpfleet/admin/reports/trips.blade.php</code></li>   <li><code>sharpfleet/admin/users/index.blade.php</code></li>   <li><code>sharpfleet/admin/users/invite.blade.php</code></li>   <li><code>sharpfleet/admin/users/edit.blade.php</code></li>   <li><code>sharpfleet/admin/users/user-rights.blade.php</code></li>   <li><code>sharpfleet/admin/register.blade.php</code></li>   <li><code>sharpfleet/admin/register-success.blade.php</code></li>   <li><code>sharpfleet/admin/activate-account.blade.php</code></li>   <li><code>sharpfleet/admin/activate-driver.blade.php</code></li>   <li><code>sharpfleet/admin/trial-expired.blade.php</code></li>   <li><code>sharpfleet/admin/login.blade.php</code> (present; usage unclear/possibly legacy)</li>   <li><code>sharpfleet/support.blade.php</code></li>   <li><code>sharpfleet/mobile/sheets/fuel-entry.blade.php</code></li>   <li><code>emails/sharpfleet/fuel-receipt.blade.php</code></li> </ul>  <p class="muted">Internal platform admin views (<code>resources/views/admin/sharpfleet/**</code>):</p> <ul>   <li><code>admin/sharpfleet/index.blade.php</code></li>   <li><code>admin/sharpfleet/organisations/show.blade.php</code></li>   <li><code>admin/sharpfleet/organisations/users.blade.php</code></li>   <li><code>admin/sharpfleet/organisations/vehicles.blade.php</code></li>   <li><code>admin/sharpfleet/vehicles/show.blade.php</code></li> </ul>  </body> </html>


